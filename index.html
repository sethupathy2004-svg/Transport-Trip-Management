<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transport Trip Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

*{box-sizing:border-box;margin:0;padding:0}

body{
font-family:Poppins,sans-serif;
background:radial-gradient(circle at top,#0f2027,#203a43,#000);
padding:20px;
}

.container{
max-width:1100px;
margin:auto;
background:white;
padding:25px;
border-radius:16px;
box-shadow:0 20px 60px rgba(0,0,0,0.4);
}

h2{text-align:center;margin-bottom:20px}

button{
padding:10px 20px;
border:none;
border-radius:20px;
cursor:pointer;
font-weight:600;
}

.add-btn{background:linear-gradient(135deg,#facc15,#f59e0b);}
.cancel{background:#e5e7eb}
.export{background:#4ade80}

input, textarea{
padding:8px;
border-radius:6px;
border:1px solid #ccc;
width:100%;
}

textarea{
resize:none;
min-height:100px;
padding:12px;
box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
transition: border 0.3s, box-shadow 0.3s;
}

textarea:focus{
border-color:#f59e0b;
box-shadow:0 0 5px rgba(245,158,11,0.4);
outline:none;
}

label{font-size:13px;margin-top:10px;display:block}

.form-grid {
    display: grid;
    grid-template-columns: 1fr; /* MOBILE: single column */
    gap: 20px;
}

@media (min-width: 992px) {
    .form-grid {
        grid-template-columns: 1fr 1fr; /* DESKTOP: 2 columns */
    }

    .buttons,
    h3,
    table {
        grid-column: span 2;
    }
}

.section{border:1px solid #ddd;padding:15px;border-radius:10px;margin-bottom:15px}

.table-wrap{
    overflow-x:auto;
    width:100%;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    font-size:12px;
    white-space:nowrap;
}

th,td{
border:1px solid #ddd;
padding:8px;
text-align:center;
}

th{background:#facc15}
.actions button{
    padding:8px 16px;
    font-size:14px;
    border-radius:8px;
    font-weight:600;
    margin:4px;
    min-width:70px;
}

.edit{
    background:#3b82f6;
    color:white;
}

.delete{
    background:#ef4444;
    color:white;
}
.actions{
    display:flex;
    justify-content:center;
    gap:6px;
    flex-wrap:wrap;
}

@media (max-width:768px){
    .actions{
        flex-direction:column;
        align-items:stretch;
    }

    .actions button{
        width:100%;
        min-width:0;
        padding:8px;
        font-size:13px;
    }
}



.filters{
display:flex;
gap:10px;
margin-bottom:15px;
flex-wrap:wrap;
}
.popup{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:9999;
    display:none;
}

.small-popup{
    background:#fff;
    width:360px;              /* fixed like GitHub version */
    max-width:90vw;
    padding:20px;
    border-radius:14px;
    box-shadow:0 15px 40px rgba(0,0,0,0.25);
}

th {
    position: relative;
    cursor: pointer;
}

.filter-box {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    z-index: 9999;
    display: none;
    width: 180px;
    box-shadow: 0 4px 15px rgba(0,0,0,.2);
}

.filter-box input {
    width: 100%;
    margin-bottom: 6px;
    padding: 6px;
}

.filter-box button {
    width: 100%;
    margin-top: 4px;
    padding: 6px;
    border-radius: 6px;
    font-size: 12px;
}

.header-bar{
    display:grid;
    grid-template-columns: 1fr auto;
    align-items:center;
    gap:20px;
}

.left-filters{
    display:grid;
    grid-template-columns: 
        1.2fr   /* ID */
        1fr     /* Date */
        1.2fr   /* Vehicle */
        1.4fr   /* Transport */
        1fr     /* Source */
        1fr     /* Destination */
        0.9fr   /* Total */
        1fr     /* Advance */
        1fr     /* Balance */
        1.2fr;  /* Action */
    gap:14px;
    align-items:center;
}




.right-actions{
    display:flex;
    gap:10px;
}

#searchBox{
   
    width:100%;   
    padding:12px 14px;
    font-size:15px;
    font-weight:500;
    border-radius:10px;
    border:2px solid #facc15;
    box-shadow:0 0 0 3px rgba(250,204,21,0.25);
}

#searchBox:focus{
    outline:none;
    border-color:#f59e0b;
    box-shadow:0 0 0 4px rgba(245,158,11,0.35);
}

.search-wrap{
    grid-column: span 4;   /* ID + Date + Vehicle + Transport */
}

.date-wrap{
    grid-column: span 1;   /* Source + Destination */
}
.btn-wrap{
    grid-column: span 3;   /* Total + Advance + Balance */
    display:flex;
    gap:12px;
    justify-content:flex-end;
}

.autocomplete-box {
  position: relative;
}

.autocomplete-list {
  position: absolute;
  width: 100%;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  max-height: 180px;
  overflow-y: auto;
  z-index: 999;
}

.autocomplete-list div {
  padding: 10px;
  cursor: pointer;
}

.autocomplete-list div:hover {
  background: #facc15;
}

body.modal-open {
    overflow: hidden;
}
@media (max-width: 768px) {

  .left-filters{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .search-wrap,
  .date-wrap,
  .btn-wrap{
    grid-column: auto;
    width: 100%;
  }

  .btn-wrap{
    justify-content: space-between;
  }

  #searchBox{
    font-size: 14px;
    padding: 10px;
  }

  button{
    width: 100%;
  }
}
input[type="date"]{
    color:#111;
    background:#fff;
    font-size:14px;
}

/* show placeholder when empty */
input[type="date"]:not(:valid){
    color:#999;
}

/* force placeholder text */
#filterDate::before{
    content: "Select date";
    color:#999;
}

#filterDate:valid::before{
    content:"";
}




</style>
</head>

<body>

<div class="container">
<h2>üöõ Transport Trip Management</h2>

<!-- TABLE VIEW -->
<div id="tableView">
<div class="left-filters">

    <div class="search-wrap">
        <input type="text" id="searchBox" placeholder="üîç Search vehicle / transport">
    </div>

    <div class="date-wrap">
        <input type="date" id="filterDate">
    </div>

    <div class="btn-wrap">
        <button class="export" onclick="exportExcel()">Export Excel</button>
        <button class="add-btn" onclick="openForm()">‚ûï Add Trip</button>
    </div>

</div>



<table id="tripTable">
<thead>
<tr>
<th onclick="openFilter(0,this)">ID ‚è∑</th>
<th onclick="openFilter(1,this)">Date ‚è∑</th>
<th onclick="openFilter(2,this)">Vehicle ‚è∑</th>
<th onclick="openFilter(3,this)">Transport ‚è∑</th>
<th onclick="openFilter(4,this)">Source ‚è∑</th>
<th onclick="openFilter(5,this)">Destination ‚è∑</th>
<th onclick="openFilter(6,this)">Total ‚è∑</th>
<th onclick="openFilter(7,this)">Advance ‚è∑</th>
<th onclick="openFilter(8,this)">Balance ‚è∑</th>
<th>Action</th>
</tr>
</thead>

<tbody></tbody>
</table>
<div id="pagination" style="margin-top:15px;text-align:center"></div>

</div>

<!-- FORM VIEW -->
<div id="formView" style="display:none">

<form id="tripForm" novalidate>

<div class="form-grid">

<div class="section">
<h3>Trip Information</h3>
<label>Trip Date</label>
<input type="date" id="tripDate" required>

<label>Vehicle Number</label>
<input type="text" id="vehicleNumber" required>

<div class="autocomplete-box">
    <label>Transport Name</label>
  <input type="text" id="transportInput" placeholder="Search or add transport..." autocomplete="off">
  <div id="transportDropdown" class="autocomplete-list"></div>
</div>


<label>Transport Address</label>
<input type="text" id="transportAddress" required>

<label>Transport Phone</label>
<input type="text" id="transportPhone" required>



</div>

<div class="section">
<h3>Route</h3>
<label>Source</label>
<input type="text" id="source" required>

<label>Destination</label>
<input type="text" id="destination" required>
</div>

<div class="section">
<h3>Load & Price</h3>
<label>Price Per Ton</label>
<input type="number" id="pricePerTon" required>

<label>Load Weight</label>
<input type="number" id="loadWeight" step="0.001" min="0" required>

<label>Unload Weight</label>
<input type="number" id="unloadWeight" step="0.001" min="0">
</div>

<div class="section">
<h3>Payment</h3>
<label>Payment Details</label>
<textarea id="paymentdetails" placeholder="Enter the Payment Details"></textarea>
<label>Advance Amount</label>
<input type="number" id="advanceAmount" required>
<label>Total</label>
<input id="total" readonly>


<label>Balance</label>
<input id="balance" readonly>
</div>

<!-- Feedback Section -->
<div class="section">
<h3>Feedback</h3>
<label>Feedback</label>
<textarea id="feedback" placeholder="Enter any feedback or notes here"></textarea>
</div>

</div>

<div style="text-align:center;margin-top:20px">
<button class="add-btn" type="submit">Save</button>
<button type="button" class="cancel" onclick="openTable()">Cancel</button>
</div>

</form>
</div>
</div>

<div class="popup" id="transportPopup">
  <div class="small-popup">
    <h3 style="margin-bottom:8px">Add Transport</h3>

    <label>Name</label>
    <input id="tName">

    <label>Address</label>
  <textarea id="tAddress" rows="3" style="width:100%"></textarea>


    <label>Contact No</label>
    <input id="tPhone">

    

    <div style="margin-top:12px;text-align:right">
      <button class="add-btn" onclick="saveTransport()">Save</button>
<button type="button" class="cancel" onclick="closeTransportPopup()">Cancel</button>



    </div>
  </div>
</div>


<script>
let currentPage = 1;
const rowsPerPage = 10;

let trips = JSON.parse(localStorage.getItem("trips") || "[]");
let transports = JSON.parse(localStorage.getItem("transports") || "[]");

let editId = null;

const tableBody = document.querySelector("#tripTable tbody");
const formView = document.getElementById("formView");
const tableView = document.getElementById("tableView");
const tripForm = document.getElementById("tripForm");
const transportInput = document.getElementById("transportInput");
const popup = document.getElementById("transportPopup");

/* --------- Navigation --------- */
function openForm(){
    clearForm();
    document.getElementById("transportDropdown").innerHTML = "";
    formView.style.display="block";
    tableView.style.display="none";
}

let activeFilters = {};
let sortColumn = null;
let sortDir = "asc";

function openFilter(col, th){
    document.querySelectorAll(".filter-box").forEach(f=>f.remove());

    const box = document.createElement("div");
    box.className = "filter-box";
    box.innerHTML = `
        <button onclick="sortAsc(${col})">‚¨Ü Sort A-Z</button>
        <button onclick="sortDesc(${col})">‚¨á Sort Z-A</button>
        <button onclick="clearFilter(${col})">‚ùå Clear</button>
    `;
    th.appendChild(box);
    box.style.display="block";
}


function setFilter(col,val){
    activeFilters[col] = val.toLowerCase();
    loadTable();
}

function sortAsc(col){
    sortColumn = col;
    sortDir = "asc";
    currentPage = 1;
    loadTable();
}

function sortDesc(col){
    sortColumn = col;
    sortDir = "desc";
    currentPage = 1;
    loadTable();
}

function clearFilter(col){
    delete activeFilters[col];

    if(sortColumn === col){
        sortColumn = null;
        sortDir = "asc";
    }

    currentPage = 1;
    loadTable();
}

function openTable(){
    formView.style.display="none";
    tableView.style.display="block";
    loadTable();
}


transportInput.addEventListener("input", function () {
    const value = this.value.toLowerCase();
    const dropdown = document.getElementById("transportDropdown");
    dropdown.innerHTML = "";

    let found = false;

    transports.forEach(t => {
        if (t.name.toLowerCase().includes(value)) {
            let div = document.createElement("div");
            div.textContent = t.name;
            div.onclick = () => selectTransport(t);
            dropdown.appendChild(div);
            found = true;
        }
    });

    if (!found && value.trim() !== "") {
        let add = document.createElement("div");
        add.innerHTML = `‚ûï Add "<b>${this.value}</b>"`;
        add.onclick = () => openTransportPopup(this.value);
        dropdown.appendChild(add);
    }
});


function selectTransport(t){
    transportInput.value = t.name;
    transportAddress.value = t.address || "";
    transportPhone.value = t.phone || "";
    document.getElementById("transportDropdown").innerHTML = "";
}




/* --------- Auto Calculation --------- */
pricePerTon.oninput = loadWeight.oninput = unloadWeight.oninput = advanceAmount.oninput = () => {
    const load = +loadWeight.value || 0;
    const unload = +unloadWeight.value || 0;
    const price = +pricePerTon.value || 0;

    const delivered = Math.max(load - unload, 0);
    const totalCalc = delivered * price;

    total.value = totalCalc.toFixed(2);
   let adv = +advanceAmount.value || 0;
if(adv > totalCalc){
    advanceAmount.value = totalCalc.toFixed(2);
    adv = totalCalc;
}
balance.value = (totalCalc - adv).toFixed(2);

};

function generateTripId(){
    let last = localStorage.getItem("lastTripId") || 0;
    last = parseInt(last) + 1;
    localStorage.setItem("lastTripId", last);
    return "TR-" + String(last).padStart(4, "0");
}


/* --------- Save Trip --------- */
tripForm.onsubmit = e => {
    e.preventDefault();

    if (!tripDate.value || !vehicleNumber.value.trim() || !transportInput.value.trim() ||
        !source.value.trim() || !destination.value.trim() ||
        !pricePerTon.value || !loadWeight.value || !advanceAmount.value) {
        alert("Please fill all required fields before saving!");
        return;
    }

   const data = {
    id: editId || generateTripId(),
    date: tripDate.value,
    vehicle: vehicleNumber.value.trim(),
    transport: transportInput.value.trim(),
    transportAddress: transportAddress.value,
    transportPhone: transportPhone.value,
    source: source.value.trim(),
    dest: destination.value.trim(),
    pricePerTon: pricePerTon.value,
    loadWeight: loadWeight.value,
    unloadWeight: unloadWeight.value,
    total: total.value,
    advance: advanceAmount.value,
    balance: balance.value,
    paymentdetails: paymentdetails.value.trim(),
    feedback: feedback.value.trim()
};


    if (editId) {
        trips = trips.map(t => t.id === editId ? data : t);
    } else {
        trips.push(data);
    }

    localStorage.setItem("trips", JSON.stringify(trips));
    editId = null;
    tripForm.reset();
    openTable();
};

function clearForm(){
    tripForm.reset();
    editId = null;
    total.value = "";
    balance.value = "";
transportAddress.value = "";
transportPhone.value = "";

}


/* --------- Transport Popup --------- */
function openTransportPopup(name="") {
    popup.style.display = "block";
    document.getElementById("tName").value = name;
    document.body.classList.add("modal-open");

}



function closeTransportPopup(){
    popup.style.display = "none";
    tName.value = "";
    tAddress.value = "";
    tPhone.value = "";
    document.body.classList.remove("modal-open");

}

function saveTransport(){
    const name = tName.value.trim();
    const address = tAddress.value.trim();
    const phone = tPhone.value.trim();

  if(!name || !tPhone.value.trim()){
    alert("Enter Transport Name and Phone");
    return;
}


    // Prevent duplicate transport
 if(transports.some(t => t.name.toLowerCase() === name.toLowerCase())){
    alert("Transport already exists");
    tName.focus();
    return;
}


    const obj = { name, address, phone };
    transports.push(obj);

    localStorage.setItem("transports", JSON.stringify(transports));

    selectTransport(obj);
    closeTransportPopup();
}


/* --------- Table --------- */
function loadTable(){
    const search = searchBox.value.toLowerCase();
    const date = filterDate.value;

    let filtered = trips.filter(t=>{
        return (!search || t.vehicle.toLowerCase().includes(search) || t.transport.toLowerCase().includes(search))
            && (!date || t.date === date);
    });

    // Column Filters
filtered = filtered.filter(t=>{
    const arr = [t.id, t.date, t.vehicle, t.transport, t.source, t.dest, t.total, t.advance, t.balance];
    return Object.keys(activeFilters).every(i => 
        arr[i].toString().toLowerCase().includes(activeFilters[i])
    );
});


// Sorting with numeric columns handled
if(sortColumn !== null){
    const keys = ["id","date","vehicle","transport","source","dest","total","advance","balance"];
    filtered.sort((a,b)=>{
        let x = a[keys[sortColumn]];
        let y = b[keys[sortColumn]];

        // Convert numeric columns to numbers for correct sorting
        if(["total","advance","balance"].includes(keys[sortColumn])){
            x = parseFloat(x);
            y = parseFloat(y);
        }

        return sortDir === "asc" ? x > y ? 1 : -1 : x < y ? 1 : -1;
    });
}


    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = filtered.slice(start, end);

    tableBody.innerHTML = "";

    pageData.forEach(t=>{
        tableBody.innerHTML += `
        <tr>
            <td>${t.id}</td>
            <td>${t.date}</td>
            <td>${t.vehicle}</td>
            <td>${t.transport}</td>
            <td>${t.source}</td>
            <td>${t.dest}</td>
            <td>${t.total}</td>
            <td>${t.advance}</td>
            <td>${t.balance}</td>
            <td class="actions">
                <button class="edit" onclick="editTrip('${t.id}')">Edit</button>
                <button class="delete" onclick="deleteTrip('${t.id}')">Delete</button>
            </td>
        </tr>`;
    });

    renderPagination(filtered.length);
}

function renderPagination(total){
    const pages = Math.ceil(total / rowsPerPage);
    const div = document.getElementById("pagination");

    if(pages <= 1){
        div.innerHTML = "";
        return;
    }

    let html = "";

    if(currentPage > 1){
        html += `<button onclick="gotoPage(${currentPage-1})">‚óÄ</button>`;
    }

    for(let i=1;i<=pages;i++){
        html += `<button 
            style="margin:0 4px;${i===currentPage?'background:#f59e0b;color:white':''}" 
            onclick="gotoPage(${i})">${i}</button>`;
    }

    if(currentPage < pages){
        html += `<button onclick="gotoPage(${currentPage+1})">‚ñ∂</button>`;
    }

    div.innerHTML = html;
}

function gotoPage(p){
    currentPage = p;
    loadTable();
}

function editTrip(id){
    clearForm();
    editId = id;

    const t = trips.find(x => x.id === id);

    tripDate.value = t.date;
    vehicleNumber.value = t.vehicle;
    transportInput.value = t.transport;
    transportAddress.value = t.transportAddress || "";
    transportPhone.value = t.transportPhone || "";
    source.value = t.source;
    destination.value = t.dest;
    pricePerTon.value = t.pricePerTon;
    loadWeight.value = t.loadWeight;
    unloadWeight.value = t.unloadWeight;
    total.value = t.total;
    advanceAmount.value = t.advance;
    balance.value = t.balance;
    paymentdetails.value = t.paymentdetails || '';
    feedback.value = t.feedback || '';

    formView.style.display="block";
    tableView.style.display="none";
}


function deleteTrip(id){
    if(!confirm("Delete this trip?")) return;
    trips = trips.filter(t => t.id !== id);
    localStorage.setItem("trips", JSON.stringify(trips));
    loadTable();
}

function exportExcel(){

    const search = searchBox.value.toLowerCase();
    const date = filterDate.value;

    let filtered = trips.filter(t=>{
        return (!search || t.vehicle.toLowerCase().includes(search) || t.transport.toLowerCase().includes(search))
            && (!date || t.date === date);
    });

    // Apply column filters
    filtered = filtered.filter(t=>{
        const arr = [t.id, t.date, t.vehicle, t.transport, t.source, t.dest, t.total, t.advance, t.balance];
        return Object.keys(activeFilters).every(i => 
            arr[i].toString().toLowerCase().includes(activeFilters[i])
        );
    });

    // Apply sorting
    if(sortColumn !== null){
        const keys = ["id","date","vehicle","transport","source","dest","total","advance","balance"];
        filtered.sort((a,b)=>{
            let x = a[keys[sortColumn]];
            let y = b[keys[sortColumn]];

            if(["total","advance","balance"].includes(keys[sortColumn])){
                x = parseFloat(x);
                y = parseFloat(y);
            }

            return sortDir === "asc" ? x > y ? 1 : -1 : x < y ? 1 : -1;
        });
    }

    let csv="ID,Date,Vehicle,Transport,Source,Destination,Total,Advance,Balance\n";

    filtered.forEach(t=>{
        csv += `"${t.id}","${t.date.replaceAll("-","/")}","${t.vehicle}","${t.transport}","${t.source}","${t.dest}","${t.total}","${t.advance}","${t.balance}"\n`;
      

    });

    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "trips.csv";
    a.click();
}


searchBox.oninput = filterDate.onchange = () => {
    currentPage = 1;
    loadTable();
};
document.addEventListener("click", function(e){
    if(!e.target.closest("th") && !e.target.closest(".filter-box")){
        document.querySelectorAll(".filter-box").forEach(f=>f.style.display="none");
    }
});


openTable();
document.addEventListener("click", function(e){
    if(!e.target.closest(".autocomplete-box")){
        document.getElementById("transportDropdown").innerHTML = "";
    }
});

</script>


</body>
</html>
